<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Preprocess and sparsify • BirdFlowR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Preprocess and sparsify">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BirdFlowR</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.1.0.9077</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/BirdFlowR.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/BirdFlowOverview.html">BirdFlow Model Overview, Uses, and Limitations</a></li>
    <li><a class="dropdown-item" href="../articles/Installation.html">Detailed installation instructions</a></li>
    <li><a class="dropdown-item" href="../articles/Polygons.html">Calculate movement among polygons</a></li>
    <li><a class="dropdown-item" href="../articles/Preprocess.html">Preprocess and sparsify</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/birdflow-science/BirdFlowR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Preprocess and sparsify</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/birdflow-science/BirdFlowR/blob/main/vignettes/Preprocess.Rmd" class="external-link"><code>vignettes/Preprocess.Rmd</code></a></small>
      <div class="d-none name"><code>Preprocess.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="load-r-packages-and-set-species-">Load R packages and set species.<a class="anchor" aria-label="anchor" href="#load-r-packages-and-set-species-"></a>
</h3>
<p>The “example_data” allows processing the <strong>ebirdst</strong>
example data, which doesn’t require an access code.</p>
<p>If you plan on preprocessing any other species be sure to <a href="https://cornelllabofornithology.github.io/ebirdst/articles/ebirdst.html#access" class="external-link">setup
an ebirdst access code</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://birdflow-science.github.io/BirdFlowR/">BirdFlowR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebird.github.io/ebirdst/" class="external-link">ebirdst</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"example_data"</span>  <span class="co"># optionally, set species here</span></span></code></pre></div>
<p>You’ll also have to setup a destination folder for the purpose of the
vignette I’m going to use a temporary folder.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>You could optionally set to a directory of your choice that is
somewhere more permanent and accessible. The code below should add a
BirdFlowModels directory to your home directory, to use for model
output. This block is not run when building the vignette.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="st">"~/BirdFlowModels"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preprocess">Preprocess<a class="anchor" aria-label="anchor" href="#preprocess"></a>
</h3>
<p>Now we can preprocess the species. The <code>gb</code> parameter is
one way of setting the resolution; it specifies the amount of ram
available on the machine where we intend to fit the BirdFlow model -
with python and Jax, and probably on a cluster. Here, we set
<code>gb</code> to a small value to keep file size and memory
requirements small.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note:</span></span>
<span><span class="co">#   amewoo 100km resolution is equivalent to gpu_ram = 1</span></span>
<span><span class="co">#   amewoo 75 km resolution is equivalent to gpu_ram = 2.9</span></span>
<span></span>
<span><span class="va">bf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/preprocess_species.html">preprocess_species</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">dir</span>, gpu_ram <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-models">Fit models<a class="anchor" aria-label="anchor" href="#fit-models"></a>
</h3>
<p>In python. Come back after you’re done.</p>
</div>
<div class="section level3">
<h3 id="import">Import<a class="anchor" aria-label="anchor" href="#import"></a>
</h3>
<p>The rest of this vignette is predicated on having an .hdf5 file with
a fitted model. Set the path to the file and import it.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"fitted.hdf5"</span><span class="op">)</span></span>
<span><span class="va">bf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/export_import_birdflow.html">import_birdflow</a></span><span class="op">(</span><span class="va">model_file</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sparsify">Sparsify<a class="anchor" aria-label="anchor" href="#sparsify"></a>
</h3>
<p>It’s a good idea to sparsify immediately after importing to reduce
memory usage and processing time for the models.</p>
<p>The state method eliminates all transitions into and out of model
states (locations in space and time) for which the ebirdst distribution
is zero. Those states are thus removed from the model.</p>
<p>You can read more about sparsification methods in the help for
<code>sparasify()</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sparsify.html">sparsify</a></span><span class="op">(</span><span class="va">bf</span>, method <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="save-sparse-model">Save sparse model<a class="anchor" aria-label="anchor" href="#save-sparse-model"></a>
</h3>
<p>Saving the sparse model will save time and disk space if we want to
use it later. Here we write it as a serialized R object which is fast
and efficient but not at all portable to other software.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sparse_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"sparse.Rds"</span><span class="op">)</span>  <span class="co"># change</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">bf</span>, file <span class="op">=</span> <span class="va">sparse_file</span><span class="op">)</span></span></code></pre></div>
<p>In a later session we could then read it with.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">sparse_file</span><span class="op">)</span></span></code></pre></div>
<p>See <code><a href="../articles/BirdFlowR.html">vignette('BirdFlowR')</a></code> for examples of routing and
forecasting with BirdFlow objects.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ethan Plunkett, National Science Foundation.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
