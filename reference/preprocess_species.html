<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Write a template BirdFlow object to an hdf5 file based on distribution data
downloaded with ebirdst. The object is complete except for marginals
and transitions."><title>prepare eBird Status and Trends data for BirdFlow model fitting — preprocess_species • BirdFlowR</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="prepare eBird Status and Trends data for BirdFlow model fitting — preprocess_species"><meta property="og:description" content="Write a template BirdFlow object to an hdf5 file based on distribution data
downloaded with ebirdst. The object is complete except for marginals
and transitions."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">BirdFlowR</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.1.0.9015</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/BirdFlowR.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Installation.html">Detailed installation instructions</a>
    <a class="dropdown-item" href="../articles/Preprocess.html">Preprocess and sparsify</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/birdflow-science/BirdFlowR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>prepare eBird Status and Trends data for BirdFlow model fitting</h1>
      <small class="dont-index">Source: <a href="https://github.com/birdflow-science/BirdFlowR/blob/HEAD/R/preprocess_species.R" class="external-link"><code>R/preprocess_species.R</code></a></small>
      <div class="d-none name"><code>preprocess_species.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Write a template BirdFlow object to an hdf5 file based on distribution data
downloaded with <span class="pkg">ebirdst</span>. The object is complete except for marginals
and transitions.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">preprocess_species</span><span class="op">(</span></span>
<span>  <span class="va">species</span>,</span>
<span>  <span class="va">out_dir</span>,</span>
<span>  res <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  hdf5 <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  tiff <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">crs</span>,</span>
<span>  <span class="va">clip</span>,</span>
<span>  <span class="va">max_params</span>,</span>
<span>  gpu_ram <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  skip_quality_checks <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  dummy_dynamic_mask <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>species</dt>
<dd><p>a species in any format accepted by <code><a href="https://rdrr.io/pkg/ebirdst/man/get_species.html" class="external-link">ebirdst::get_species()</a></code></p></dd>


<dt>out_dir</dt>
<dd><p>output directory, files will be written here. Required unless
both <code>tiff</code> and <code>hdf5</code> are TRUE.  File names created here will incorporate
the species code, resolution, and eBird version year.</p></dd>


<dt>res</dt>
<dd><p>the target resolution of the BirdFlow model in kilometers. If
<code>res</code> is NULL (default) then a resolution that results in less than <code>max_params</code>
parameters will be used, while also minimizing the resolution and limiting
the number of significant digits.</p></dd>


<dt>hdf5</dt>
<dd><p>if TRUE (default) an hdf5 file will be exported.</p></dd>


<dt>tiff</dt>
<dd><p>set to TRUE to export geoTIFF files. They are not needed to fit
the BirdFlow model.</p></dd>


<dt>overwrite</dt>
<dd><p>if TRUE (default) any pre-existing output files will be
overwritten. If FALSE pre-existing files will result in an error.</p></dd>


<dt>crs</dt>
<dd><p>coordinate reference system (CRS) to use.  Defaults to the custom
projection eBird has assigned to this species - see
<code><a href="https://rdrr.io/pkg/ebirdst/man/load_fac_map_parameters.html" class="external-link">ebirdst::load_fac_map_parameters()</a></code>). It will be interpreted by
<code><a href="https://rdrr.io/pkg/terra/man/crs.html" class="external-link">terra::crs()</a></code> to generate a well known text representation of the CRS.</p></dd>


<dt>clip</dt>
<dd><p>a polygon or the path to a file containing a polygon. It must
have a CRS and should either be a <a href="https://rdrr.io/pkg/terra/man/SpatVector-class.html" class="external-link">SpatVector()</a> object
or or produce one when called with <a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect(clip)</a></p></dd>


<dt>max_params</dt>
<dd><p>the maximum number of fitted parameters that the BirdFlow
model should contain. Ignored if <code>res</code> is not NULL.  Otherwise a resolution
will be chosen that yields this many fitted parameters. See <code>gpu_ram</code> for
the default way of setting <code>max_params</code> and <code>res</code>.</p></dd>


<dt>gpu_ram</dt>
<dd><p>Gigabytes of ram on GPU machine that will fit the models.
If <code>res</code> is NULL and <code>max_params</code> is missing this is used to estimate
<code>max_params</code>which is, in turn, used to determine the resolution. Ignored
if either<code> res</code> or <code>max_params</code> is set.</p></dd>


<dt>skip_quality_checks</dt>
<dd><p>If <code>TRUE</code> than preprocess the species even if
not all of four ranges are modeled (based on
<a href="https://rdrr.io/pkg/ebirdst/man/ebirdst_runs.html" class="external-link">ebirdst_runs()</a>).</p></dd>


<dt>dummy_dynamic_mask</dt>
<dd><p>set to TRUE to force all cells in the dynamic mask
to TRUE. This creates a BirdFlow object with a dynamic mask component
that is compatible with the current BirdFlowR package but that mimics the
older  predynamic mask BirdFlow models.  If fit the resulting object will
have transitions at every timestep among all active cells.  The only
reason to set this to TRUE is for comparsion testing and quality control
during the transition, and this parameter may eventually be dropped.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>returns a BirdFlow model object that lacks marginals, but is
otherwise complete.</p>
    </div>
    <div class="section level2">
    <h2 id="maximum-number-of-parameters">Maximum number of parameters<a class="anchor" aria-label="anchor" href="#maximum-number-of-parameters"></a></h2>
    


<p>The maximum number of parameters that can be fit is machine dependent.
2023-02-10 we tested under different resolutions with "amewoo" and
identified bounds on the maximum.</p><table class="table table"><tr><td>Machine</td><td>GPU Ram (GB)</td><td>Lower Bound (worked)</td><td>Upper Bound (failed)</td><td>Params / GB</td></tr><tr><td>titanx gpu</td><td>12GB</td><td>306804561</td><td>334693725</td><td>25567047</td></tr><tr><td>m40 gpu</td><td>24GB</td><td>557395226</td><td>610352178</td><td>23224801</td></tr></table><p>The number of parameters is the number of unmasked cells for the first
timestep + the total number of cells in the marginals which is calculated
from the dynamic mask.</p>
<p>If <code>gpu_ram</code> is used (and not <code>res</code> or <code>max_parameters</code> ) than
<code>max_parameters</code> is set to <code>23,224,801 * gpu_ram</code> (lower of two values in
table above).</p>
<p>The heuristic to determine resolution given a maximum number of parameters
must estimate the number of cells covered by the data
at a different resolution, a noisy process, so it iteratively tries to find
the smallest resolution that doesn't exceed <code>max_params</code> and then rounds to
a slightly larger resolution (fewer parameters).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="va">bf</span> <span class="op">&lt;-</span> <span class="fu">preprocess_species</span><span class="op">(</span><span class="st">"amewoo"</span>, tiff <span class="op">=</span> <span class="cn">FALSE</span>, hdf5 <span class="op">=</span> <span class="cn">FALSE</span> <span class="op">)</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="rasterize.html">rasterize_distr</a></span><span class="op">(</span><span class="fu"><a href="get_distr.html">get_distr</a></span><span class="op">(</span> <span class="va">bf</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">26</span><span class="op">)</span><span class="op">)</span>, <span class="va">bf</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create clip polgyon as an sf object</span></span></span>
<span class="r-in"><span><span class="co"># Use the extent rectangle but with western edge moved in</span></span></span>
<span class="r-in"><span><span class="co"># The clip can be anything that terra::vect will process into a polygon</span></span></span>
<span class="r-in"><span><span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="dimensions.html">ext</a></span><span class="op">(</span><span class="va">bf</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">e</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1500000</span></span></span>
<span class="r-in"><span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">e</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">e</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                   <span class="va">e</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">e</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                   <span class="va">e</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">e</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                   <span class="va">e</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">e</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                   <span class="va">e</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">e</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">sfc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">bf</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">clip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span>, geom <span class="op">=</span> <span class="va">sfc</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">bfc</span> <span class="op">&lt;-</span> <span class="fu">preprocess_species</span><span class="op">(</span><span class="st">"amewoo"</span>, tiff <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>                         hdf5 <span class="op">=</span> <span class="cn">FALSE</span>, clip <span class="op">=</span> <span class="va">clip</span> <span class="op">)</span> <span class="co"># clipped bird flow</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="rasterize.html">rasterize_distr</a></span><span class="op">(</span><span class="fu"><a href="get_distr.html">get_distr</a></span><span class="op">(</span><span class="va">bfc</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">bfc</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Ethan Plunkett, Daniel Sheldon.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

