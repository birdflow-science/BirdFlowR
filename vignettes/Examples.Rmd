---
title: "BirdFlowR examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BirdFlowR examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.width = 6,
  fig.height = 6
)
```
A brief introduction to core BirdFlow functions. 

## Load BirdFlowR model for American Woodcock
```{r setup}
library(BirdFlowR)
library(terra)

model_path <- "../../Models/amewoo.Rds"  # This may need to be changed
bf <- readRDS(model_path)

```

## Access basic information
```{r access}
dim(bf)
nrow(bf)
ncol(bf)

n_active(bf)
n_transitions(bf)
n_timesteps(bf)

print(bf)  
```

## Retrieve and plot distributions
Use timestep, character dates, date objects, or "all" to specify which distributions to retrieve. Optionally force distributions to be calculated from the marginals.

The last example saves the summer and winter distributions, which are then converted to SpatRaster objects (defined in terra) and plotted.
rasterize_distr can convert one (vector) or more (a matrix) distributions into SpatRaster objects, but needs the spatial information in the BirdFlow object, its second argument, to do so.
```{r distributions, fig.width = 7, fig.height=4}
d <- get_distr(1, bf) # get first timestep distribution (a vector)
d <- get_distr("all", bf) # get all distributions (a matrix, 1 column per timestep)
d <- get_distr("2022-12-15", bf) # get distribution based on date
d <- get_distr(1, bf, from_marginals = TRUE) # 1st timestep distribution from marginal 

d <- get_distr(c(1, 26), bf) # winter and summer
r <- rasterize_distr(d, bf) # convert to SpatRaster 
plot(r)
```

# Generate synthetic routes 
In this section we sample locations from the American Woodcock winter distribution and then route from winter to summer starting at those locations.

## Set parameters
```{r route parameters}
n_positions <-  15 # number of starting positions
n_each <- 1        # how many birds to start at each
start <- 1         # starting timestep (winter)
end <- 26          # ending timestep (summer)
```

## Generate starting locations 
First we extract the  winter distribution as a vector `d`, then we use `sample_locations()` to concentrate all the probability into a single location.  The result is still a distribution with values for each location but there is now a single 1 and the remaining values are 0. Using `n = n_positions` causes the distribution to be sampled repeatedly resulting in a matrix with a column for each (concentrated) distribution.
```{r starting locations}
d <- get_distr(start, bf)
locations  <- sample_distr(d, n = n_positions)  
```

## Convert to x and y coordinates
Collapse locations down to a vector of the index of each
non-zero value and then convert to x and y coordinates.
```{r starting locations as row and column}
ind <- apply(locations, 2, function(x) which( as.logical(x) ) )
x <- i_to_x(ind, bf)
y <- i_to_y(ind, bf)
```

## Plot the starting (winter) distribution and sampled locations
```{r plot starting distribution}
winter <- rasterize_distr(d, bf)
plot(winter, )
points(x, y)
```

## Generate routes
`route()` currently returns a list with two items (this may change):

* `points` a data.frame with a row for each timestep of each route
* `lines` sf object containing a line for each route
```{r route}
rts <- route(bf, x_coord = x, y_coord = y, start = start,
             end = end, n = n_each)
head(rts$points, 4)
```

## Plot routes 
Plot the route lines over the summer distribution along with points at the starting and ending positions.
```{r plot routes}
d <- get_distr(end, bf)
summer <- rasterize_distr(d, bf)

plot(summer) 
points( x, y, cex = .4, col = rgb(0, 0, 0, .5 ), pch = 16) # starting points
plot(rts$lines, add = TRUE, col = rgb(0, 0, 0, .2))  # routes
end_pts <- rts$points[rts$points$timestep == end, ]  # end points
points(x = end_pts$x, y = end_pts$y,
       cex = 0.4, pch = 12, col = rgb(0, 0, 0, .2) )

title(main = bf$metadata$species)

```


# Forecasting
In this section we will sample a single starting location from the winter distribution and project it forward to summer. 

## Sample starting distribution
Location will be a vector distribution with a single 1 and the remaining values 0. 
```{r starting location}
set.seed(0)
d <- get_distr(start, bf)
location <- sample_distr(d)
```

## Project forward from this location to summer
Forecast returns the distribution over time as a matrix with
one column per timestep. 

We will plot how the probability density spreads over time from the starting location.
```{r forecast}
f <- forecast(bf, location, start, end, "forward")

r <- rasterize_distr(f[, c(1, 9, 18, 26)], bf)

plot(r)
```

Alternatively we can calculate the difference between the projected distribution and the distribution of the species as a whole for the last timestep.

```{r probability over time}
projected <- f[ , ncol(f)]
diff <-  projected - get_distr(end, bf) 
plot(rasterize_distr(diff, bf))
```


